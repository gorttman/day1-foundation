apiVersion: v1
kind: ConfigMap
metadata:
  name: log-archive-scripts
  namespace: logging
data:
  archive-logs.sh: |
    #!/bin/bash
    set -e
    
    echo "==================================================================="
    echo "$(date): Starting log archive process"
    echo "==================================================================="
    
    NAS_MAC="${NAS_MAC_ADDRESS}"
    NAS_IP="${NAS_IP_ADDRESS}"
    NFS_SERVER="${NAS_IP}"
    NFS_PATH="${NFS_EXPORT_PATH}"
    MOUNT_POINT="/mnt/nas"
    SOURCE_DIR="/var/log/remote"
    ARCHIVE_DAYS="${ARCHIVE_DAYS:-7}"
    MAX_RETRIES=30
    RETRY_INTERVAL=10
    
    echo "Configuration:"
    echo "  NAS IP: ${NAS_IP}"
    echo "  NAS MAC: ${NAS_MAC}"
    echo "  NFS Path: ${NFS_PATH}"
    echo "  Archive Age: ${ARCHIVE_DAYS} days"
    echo ""
    
    wake_nas() {
      echo "$(date): Sending Wake-on-LAN packet to ${NAS_MAC}"
      if command -v wakeonlan &> /dev/null; then
        wakeonlan "${NAS_MAC}"
      elif command -v etherwake &> /dev/null; then
        etherwake "${NAS_MAC}"
      else
        echo "WARNING: No WOL tool found"
      fi
    }
    
    check_nas_online() {
      ping -c 1 -W 2 "${NAS_IP}" &> /dev/null
      return $?
    }
    
    wake_nas
    
    echo "$(date): Waiting for NAS to come online..."
    retry_count=0
    while [ $retry_count -lt $MAX_RETRIES ]; do
      if check_nas_online; then
        echo "$(date): NAS is online!"
        break
      fi
      retry_count=$((retry_count + 1))
      echo "$(date): Attempt $retry_count/$MAX_RETRIES"
      sleep $RETRY_INTERVAL
    done
    
    if [ $retry_count -eq $MAX_RETRIES ]; then
      echo "$(date): ERROR - NAS failed to come online"
      exit 1
    fi
    
    echo "$(date): Waiting for NFS service..."
    sleep 15
    
    echo "$(date): Mounting NFS share ${NFS_SERVER}:${NFS_PATH}"
    mkdir -p "${MOUNT_POINT}"
    
    if ! mount -t nfs -o vers=3,nolock "${NFS_SERVER}:${NFS_PATH}" "${MOUNT_POINT}"; then
      echo "$(date): ERROR - Failed to mount NFS share"
      exit 1
    fi
    
    echo "$(date): NFS mounted successfully"
    
    ARCHIVE_DIR="${MOUNT_POINT}"
    file_count=$(find "${SOURCE_DIR}" -type f -name "*.log" -mtime +${ARCHIVE_DAYS} 2>/dev/null | wc -l)
    echo "$(date): Found ${file_count} log files older than ${ARCHIVE_DAYS} days"
    
    if [ ${file_count} -eq 0 ]; then
      echo "$(date): No logs to archive"
    else
      echo "$(date): Archiving logs..."
      find "${SOURCE_DIR}" -type f -name "*.log" -mtime +${ARCHIVE_DAYS} | while read -r logfile; do
        relative_path="${logfile#$SOURCE_DIR/}"
        target_dir="${ARCHIVE_DIR}/$(dirname "${relative_path}")"
        mkdir -p "${target_dir}"
        
        if mv "${logfile}" "${target_dir}/"; then
          echo "$(date): ✓ Archived ${relative_path}"
        else
          echo "$(date): ✗ Failed ${relative_path}"
        fi
      done
    fi
    
    echo "$(date): Syncing data..."
    sync
    
    echo "$(date): Unmounting NFS share..."
    if ! umount "${MOUNT_POINT}"; then
      echo "$(date): WARNING - Failed to unmount cleanly"
      umount -f "${MOUNT_POINT}" || true
    fi
    
    echo "==================================================================="
    echo "$(date): Log archive completed"
    echo "==================================================================="

